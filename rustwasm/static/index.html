<!DOCTYPE html>
<html>

<head>
    <title>Mal on the Rust+WebAssembly</title>
    <meta charset="UTF-8">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/1.0.10/js/jquery.terminal.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/1.0.10/css/jquery.terminal.css" rel="stylesheet" />
</head>

<body>
    <h2>Mal on the Rust+WebAssembly</h2>

    <div id="terminal"></div>

    <script type='text/javascript'>
        "use strict";

        const namePrefix = "lib";
        var Module = {
            preRun: [],
            postRun: [],
            wasmBinaryFile: `${namePrefix}.wasm`,
            noInitialRun: true,
            print: text => {
                console.log(text);
            },
            printErr: text => {
                console.warn(text);
            },
        };
        fetch(`${namePrefix}.wasm`)
            .then(resp => resp.arrayBuffer())
            .then(ab => {
                Module.wasmBinary = ab;

                return new Promise(resolve => {
                    const script = document.createElement("script");
                    script.src = `${namePrefix}.js`;
                    script.addEventListener("load", resolve);
                    document.body.appendChild(script);
                });
            })
            .then(() => {
                const cNewReplEnv = Module.cwrap("c_new_repl_env", "number", []);
                const cEnvFree = Module.cwrap("c_env_free", void 0, ["number"]);
                const cREP = Module.cwrap("c_rep", void 0, ["number", "string", "number"]);
                const cSetStdoutln = Module.cwrap("c_set_stdoutln", void 0, ["number"]);

                class Mal {
                    constructor() {
                        this.envPtr = cNewReplEnv();
                        this.stdoutFuncPtr = Runtime.addFunction(ptr => {
                            const stdout = Module.Pointer_stringify(ptr);
                            if (this.stdoutCallback) {
                                this.stdoutCallback(stdout);
                            }
                        });
                        cSetStdoutln(this.stdoutFuncPtr);
                    }

                    setStdoutListener(callback) {
                        this.stdoutCallback = callback;
                    }

                    rep(expr, callback) {
                        let funcPtr = 0;
                        const wrapper = (malResultPtr, malErrorPtr) => {
                            const malResult = Module.Pointer_stringify(malResultPtr);
                            const malError = Module.Pointer_stringify(malErrorPtr);

                            callback({
                                result: malResult,
                                error: malError,
                            });

                            if (funcPtr) {
                                Runtime.removeFunction(funcPtr);
                                funcPtr = 0;
                            }
                        };
                        funcPtr = Runtime.addFunction(wrapper);
                        cREP(this.envPtr, expr, funcPtr);
                    }

                    drop() {
                        cSetStdoutln(0);
                        Runtime.removeFunction(this.stdoutFuncPtr);
                        cEnvFree(this.envPtr);
                    }
                }

                window.Mal = Mal;
                const mal = new Mal();
                window.mal = mal;

                class MalTerminal {
                    constructor({el, prompt, mal}) {
                        this.el = el || document.querySelector("#terminal");
                        this.prompt = prompt || "user> ";
                        this.mal = mal;
                    }

                    open() {
                        const opts = {
                            height: 200,
                            width: 450,
                            prompt: this.prompt,
                            greetings: "Mal on Rust+WebAssembly (https://github.com/kanaka/mal)",
                            name: "",
                        };
                        this.term = jQuery(this.el).terminal((command, term) => {
                            this.onLine(command);
                        }, opts);

                        this.mal.setStdoutListener(stdout => {
                            this.term.echo(stdout);
                        });
                    }

                    onLine(input) {
                        mal.rep(input, ret => {
                            const {result, error} = ret;
                            if (!error) {
                                this.term.echo(result);
                            } else {
                                this.term.echo(error);
                            }
                        });
                    }
                }

                window.MalTerminal = MalTerminal;
                const el = document.querySelector("#terminal");
                const terminal = new MalTerminal({ el, mal });
                terminal.open();
                window.malTerminal = terminal;
            });
    </script>
</body>

</html>